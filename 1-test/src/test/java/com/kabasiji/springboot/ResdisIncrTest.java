package com.kabasiji.springboot;

import lombok.extern.log4j.Log4j2;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.test.context.junit4.SpringRunner;

import java.util.Random;
import java.util.concurrent.CountDownLatch;

/**
 * @author huang_kangjie
 * @date 2019-04-19 16:29
 * @since 1.0.3
 **/
@RunWith(SpringRunner.class)
@SpringBootTest
@Log4j2
public class ResdisIncrTest {

     @Autowired
     private StringRedisTemplate redisTemplate;

     @Test
     @SuppressWarnings("unchecked")
     public void redisTest(){
          String key = "test";
          String key2 = "test2";
          redisTemplate.opsForValue().set(key, 0+"");
          redisTemplate.opsForHash().put(key2, "test-1", 0+"");
          redisTemplate.opsForHash().put(key2, "test-2", 0+"");
          //并发消费测试
          //模拟集合点，每多少秒进行一次压力并发
          int round = 10;
          for(int r = 1; r <= round; r++) {
               int thread = 200;

               CountDownLatch signal = new CountDownLatch(1);
               CountDownLatch finish = new CountDownLatch(thread);


               for(int i = 0 ; i < thread; i++){
                    Thread t = new Thread(new Runnable() {
                         @Override
                         public void run() {
                              try {
                                   //所有的线程等待这儿
                                   signal.await();
                                   int num = new Random().nextInt(10) - 5;
                                   //System.out.println("分数：" + num);
                                   redisTemplate.opsForValue().increment(key, Double.valueOf(num));
                                   redisTemplate.opsForHash().increment( key2, "test-2", Double.valueOf(num));

                                   finish.countDown();

                              } catch (InterruptedException e) {
                                   e.printStackTrace();
                              }
                         }
                    });

                    t.start();

               }


               try {
                    signal.countDown();
                    finish.await();
               } catch (InterruptedException e) {
                    e.printStackTrace();
               }

               System.out.println( "执行完请求轮：" + r);
               try {
                    Thread.sleep(1000 * 5);
               } catch (InterruptedException e) {
                    e.printStackTrace();
               }
          }
     }

     public static void main(String[] args) {
          String t[] = {"1","2","-4","1","3","3","-4","4","-2","1","-4","-3","0","-2","4","4","1","-1","3","0","4","3","3","3","3","-4","0","0","4","-2","-1","3","3","-1","4","1","-2","-3","-4","2","-3","-3","2","1","-3","2","-2","2","-1","3","3","0","2","2","-2","4","-5","2","-3","-2","2","-5","1","3","-2","-4","4","-5","0","-2","-3","-2","4","1","1","4","4","-5","-4","-5","3","-5","4","2","-4","1","-2","0","0","-3","-1","2","1","0","3","-2","-1","4","-1","-1","0","-2","0","-2","4","2","-5","4","-5","-4","-2","3","-5","-5","0","-4","-3","0","3","4","-4","2","-4","4","0","1","3","-5","-2","1","-2","-4","2","-5","-1","-3","3","-1","2","2","-3","0","3","-3","-1","-4","1","0","0","-3","4","-5","1","-4","-1","-2","-4","2","3","-2","-2","2","3","3","-4","-5","-1","3","-5","2","-5","2","1","-3","4","-3","-5","-4","1","-4","1","2","-1","3","4","3","-1","-3","-3","2","1","1","-3","-2","-5","-5","-2","-5","-2","-2","4","-5","0","1","4","2","1","2","3","-3","4","-1","-2","-1","2","4","-2","-3","-2","-3","3","0","-1","-5","2","3","-1","2","3","-2","1","-5","-4","1","1","-3","2","1","-3","2","2","4","-1","-5","0","3","2","2","-3","-1","-2","4","4","-3","-1","-5","-2","-4","4","-2","0","4","-3","3","4","2","4","4","0","-3","-1","0","1","-2","2","-5","4","1","-3","2","-5","-1","-2","3","-2","1","-3","-1","3","2","0","-1","-3","0","1","-5","-2","-5","-5","-3","1","1","-4","2","-5","4","1","2","1","4","-5","0","-3","-3","1","1","-2","-4","1","-4","-2","2","-5","-4","1","2","-3","-4","-5","3","-2","-3","-1","-2","3","-1","0","4","-4","1","0","4","4","-5","-4","-2","-4","3","4","2","-3","3","2","-3","0","0","-5","-4","3","1","0","1","-1","-5","3","1","1","-2","4","-4","0","-2","-2","-2","3","3","-3","2","1","2","-4","0","-4","-3","4","-1","-3","1","4","-2","2","-4","-4","-2","-5","2","2","-5","1","-3","-5","-4","4","-2","-3","2","-3","4","-4","-1","0","-4","-5","1","-4","0","2","-3","-1","3","-4","-4","2","-2","-1","1","2","4","2","1","3","1","-4","-4","-2","-5","-4","-5","-4","1","-1","-1","-2","0","3","4","-4","-1","-5","-3","2","3","0","-4","3","4","-5","3","4","-5","4","0","0","-3","4","4","-1","-3","4","1","-3","-2","-5","-5","4","4","3","-2","3","-4","-1","2","0","-1","3","2","-4","-3","-5","1","-3","1","3","1","0","-3","-2","0","-1","-3","-4","-5","-4","2","4","0","0","-4","-3","2","-2","-3","3","4","-2","-2","2","0","-5","2","3","-1","-2","0","4","-4","4","1","-4","-2","-4","-2","-2","-4","-2","-3","-4","3","-2","2","0","1","-2","-4","-2","-2","-1","-4","4","-2","1","-3","-5","2","3","3","4","-5","-5","-1","-2","-4","-4","-4","1","3","-3","4","-1","4","4","-4","-2","2","-5","-3","2","-2","-3","-4","0","4","-2","2","-4","2","4","3","0","3","1","2","3","1","-4","0","-2","-3","3","0","-1","-1","3","-1","0","-1","-5","3","2","1","0","1","-4","3","-3","2","-5","-2","3","-2","4","-3","1","2","0","1","0","-4","-2","2","-2","4","-1","1","2","-4","0","-3","3","4","-4","-5","3","-1","4","-4","0","-3","-4","-1","-5","-1","2","-1","-2","2","1","-5","4","2","3","-5","-5","4","3","4","3","2","-3","-4","-3","-4","-1","-5","-1","-2","-3","-4","2","3","-5","-4","-5","1","-4","-3","4","-1","3","0","-3","2","3","-2","3","-1","2","-1","-5","-3","0","-5","-1","4","1","-3","1","-5","-3","-5","2","0","2","2","-3","3","-2","-3","2","-1","3","-2","1","-2","4","-3","-4","2","-5","-1","-4","3","-3","-2","2","-1","1","-3","2","3","2","3","3","-1","-4","-2","4","-2","4","-1","4","2","2","-5","-4","1","2","2","-1","-5","0","1","-3","-2","-2","3","2","4","-2","2","-5","1","3","-2","2","1","4","3","4","-1","0","-5","-1","-4","1","-5","3","-4","-3","1","-5","2","4","-3","3","-2","4","3","2","1","2","-5","-4","-1","1","1","4","-1","1","-2","0","-3","-3","-2","1","-2","-3","2","-3","-1","-5","-4","2","0","0","1","0","-1","4","-1","-3","-5","2","-2","1","-2","2","2","4","-1","0","3","2","3","-5","2","0","1","-5","-4","-1","-4","-4","0","-4","1","-3","-2","4","-5","-2","-1","3","-2","0","-2","0","-2","-4","-3","-4","3","2","0","-3","-1","3","-3","2","2","-1","-3","-5","2","4","0","-3","4","0","1","1","-3","-3","1","3","4","-1","-2","-4","0","2","1","-4","-1","-5","-5","-4","0","-4","0","-5","2","3","0","-1","-2","-5","1","-4","-1","3","1","-4","3","-3","-4","2","1","0","3","-3","-5","-5","-5","2","-5","3","-2","-4","2","3","-4","3","2","1","-2","3","1","1","2","2","-5","-2","-4","-3","1","-2","-2","0","2","2","4","3","3","-2","-1","-2","-3","-5","2","-1","4","0","-4","2","-3","0","-2","-3","-3","-4","-5","2","0","-3","1","-4","2","4","1","-2","2","2","-2","4","-4","-2","-1","4","-1"};
          int test = 0;

          for (String num : t){
               test += Integer.valueOf(num);
          }
          System.out.println(test);
     }

}
